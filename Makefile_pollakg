#include ./make.inc_kaust
include ./make.inc


LIBS	    = $(SCALAPACK) $(BLACS) $(LAPACK) $(BLAS) $(LINKS) $(OPEN_MP) $(CUDA) $(MAGMA) $(F90_LIBS)

SRC_DIR := .
INC_DIR := .
INC_CC   := -I$(INC_DIR)
C_EXTEN := C
BUILD_DIR := .
BIN_DIR := $(BUILD_DIR)
OBJ_DIR := $(BUILD_DIR)
EXEC := $(BIN_DIR)/main
DEPDIR := .deps
DEPFLAGS = -MT $@ -MMD -MP -MF $(DEPDIR)/$*.d

DEBUG ?= 0
ifeq ($(DEBUG), 1)
	DEBUG_FLAGS  =-DDEBUG -g -Wall -fsanitize=address,signed-integer-overflow
	DEBUG_FLAGS_NVCC=-DDEBUG -g
	CXXFLAGS     += -O0
else ifeq ($(DEBUG), 2)
	DEBUG_FLAGS  +=-DDEBUG -g -Wall -fno-stack-protector
	CXXFLAGS     += -O0
	DEBUG_FLAGS_NVCC=-DDEBUG -g
else
	CXXFLAGS     += -O3 -ffast-math -funroll-loops -DMPICH_IGNORE_CXX_SEEK
	NVCC_FLAGS   +=
	DEBUG_FLAGS=-DNDEBUG
	DEBUG_FLAGS_NVCC=-DNDEBUG
endif

CC_FILES   = Utilities main
CU_FILES   = CWC_utility
# ============================== Source Files
CC_SRC := $(wildcard $(SRC_DIR)/*.$(C_EXTEN))
CU_SRC := $(wildcard $(SRC_DIR)/*.cu)
# ============================== Object Files
CC_OBJ := $(CC_SRC:$(SRC_DIR)/%.$(C_EXTEN)=$(OBJ_DIR)/%.o)
# same as: CC_OBJ := $(patsubst $(SRC_DIR)/%.$(C_EXTEN), $(OBJ_DIR)/%.o, $(CC_SRC))
CU_OBJ := $(CU_SRC:$(SRC_DIR)/%.cu=$(OBJ_DIR)/%.o)
# same as: CU_OBJ := $(patsubst $(SRC_DIR)/%.cu, $(OBJ_DIR)/%.o, $(CU_SRC))

.PHONY: all clean

all: $(EXEC)
$(EXEC): $(CC_OBJ) $(CU_OBJ)
	$(LOADER) $^ $(LINKFLAGS) $(LOADFLAGS) $(LIBS) -lm -o $@ $(DEBUG_FLAGS)

# Compile C++ source files to object files:
$(OBJ_DIR)/%.o: $(SRC_DIR)/%.$(C_EXTEN) | $(OBJ_DIR) $(BIN_DIR) $(DEPDIR)
	@echo "Compiling .$(C_EXTEN) files"
	$(CXX) $(CXXFLAGS) $(FLAGS) $(INC_CC) $(INC_MAG) $(DEBUG_FLAGS) -c $< -o $@
# $(DEPFLAGS)

# Compile CUDA source files to object files:
$(OBJ_DIR)/%.o: $(SRC_DIR)/%.cu | $(OBJ_DIR) $(BIN_DIR)
	@echo "Compiling .cu files"
	$(NVCC) $(NVCC_FLAGS) $(INC_CC) $(INC_CUD) $(INC_MAG) $(DEBUG_FLAGS_NVCC) -c $< -o $@ $(NVCC_LIBS)

$(BIN_DIR):
	@mkdir -p $@

$(OBJ_DIR):
	@mkdir -p $@

$(DEPDIR):
	@mkdir -p $@

DEPFILES := $(SRCS:%.$(C_EXTEN)=$(DEPDIR)/%.d)
$(DEPFILES):
	include $(wildcard $(DEPFILES))

clean:	
	@$(RM) -rv $(BUILD_DIR)
